<!DOCTYPE html>
<html>
    <head>
        <title>StrategyBlocks Light Browser Test (Compiled)</title>
        
        <script src="/test/lib/require.js"></script>

        <link rel="stylesheet/less" type="text/css" href="/test/css/web_test.less">

        <script>
        	require.config({
        		baseUrl:"/",
        		paths: {
        			"jquery":"/test/lib/jquery-1.8.3.min",	
        			"less":"/test/lib/less-1.3.3.min",
        			"sb_light": "/bin/sb_light.uncompressed",
        			"widgets": "/src/widgets", 
        		},
        		shim: {
        			"jquery": {exports: "$"},
        			"less": {exports:"less"}
        		}
        	});
        	
        	require(["jquery", "less","sb_light", "widgets/formInput"], function($,less,sb) {
        		

        		$('#login_form').submit(function() {
        			var list = $(this).serializeArray();
        			sb.state.login(list[0].value, list[1].value);
        			return false;
        		});
        		
        		
				function handleSession(e) {
					if(sb.state.unauthorized()) {
						sb.ext.debug("Unauthorized. Prompting for authentication.");
						userLogin();	
					} else {
						sb.ext.debug("Authorized. Fetching blocks.");
						sb.models.subscribe("blocks", handleBlocks);
					}
				}
							
				function handleBlocks() {
					var blocks = sb.models.rawArray("blocks");
					sb.ext.debug("blocks: ", blocks ? blocks.length : "none");	
					changePage("blocksPage");
					
				}
			
				function userLogin() {
					changePage("loginPage");
					
				}
				
				function changePage(p) {
					$(".page").each(function(i,el) {
						console.log("EL: ", el);
						if(el.id == p) { 
							$(el).addClass("selected");
							if(p == "blocksPage") {
								$(el).append("<h1>Blocks Fetched: " + moment().fromNow() + "</h1>");
							}
						} else {
							$(el).removeClass("selected");
						}
					});
				}
				console.log(sb);	
				sb.state.host = window.location.host;
				sb.api.ajax = sb.ajax.jquery($);
				
				sb.state.watchContext("session", handleSession);
				//sb.model.subscribe("blocks", handleBlocks);
				sb.state.login();        		  		
        			
        	})
        </script>
        <style>
        	
        </style>
    </head>
    <body>
    	<div class="page selected" id="welcomePage">
    		<h1>StrategyBlocks Light Browser Test (Compiled)</h1>
    		
    	</div>
        <div class="page" id="loginPage">
			<form id="login_form" name="login_form" action="/login/auth.html" method="post">
				<div class="form-input-elements">
					<p>
						<label>Email: </label>
						<input size="40" type="text" name="username" id="email" tabindex="1"  value=""></input>
					</p>
					<p>
						<label>Password: </label>
						<input size="40" type="password" name="password" id="password" tabindex="2"></input>
					</p>
					<p class="forgot_password">
						<label>&nbsp;</label>
						<a href="#"  title="Forgot your password?" onclick="sblocks_forgot_password()" tabindex="4">Forgot your password?</a>
					</p>
					<input type="hidden" name="url_hash" value="" ></input>
				</div>
				<div class="form-buttons-container">
					<input name="Sign in"  class="signin-button" type="submit" id="Sign in" value="Sign in" title="Sign in" tabindex="3"></input>
					<div>
						or  &nbsp; <a href="/register.html" target="_blank" rel="noopener noreferrer" title="create an account" tabindex="5">create an account</a>.
					</div>
					<div class="clear"></div>
				</div>
			</form>        	
        </div>
        <div class="page" id="blocksPage">
        	  	
        	
        </div>
    </body>
</html>